# ============================================
# NguliKuy - Apache Configuration
# Optimized for Shared Hosting (Niagahoster/cPanel)
# ============================================

# Enable Rewrite Engine
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    
    # Force HTTPS (Uncomment jika sudah ada SSL)
    # RewriteCond %{HTTPS} off
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # Force WWW (Optional - uncomment jika ingin paksa www)
    # RewriteCond %{HTTP_HOST} !^www\.
    # RewriteRule ^(.*)$ https://www.%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # Protect against script injection
    RewriteCond %{QUERY_STRING} (<|%3C)([^s]*s)+cript.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|[|%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|[|%[0-9A-Z]{0,2})
    RewriteRule .* - [F,L]
</IfModule>

# ============================================
# SECURITY HEADERS
# ============================================
<IfModule mod_headers.c>
    # Prevent clickjacking
    Header set X-Frame-Options "SAMEORIGIN"
    
    # Prevent MIME type sniffing
    Header set X-Content-Type-Options "nosniff"
    
    # XSS Protection
    Header set X-XSS-Protection "1; mode=block"
    
    # Referrer Policy
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Remove server signature
    Header unset Server
    Header unset X-Powered-By
    
    # HSTS (Uncomment jika sudah HTTPS)
    # Header set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
</IfModule>

# ============================================
# PROTECT SENSITIVE FILES
# ============================================

# Protect .env file
<FilesMatch "^\.env">
    Order allow,deny
    Deny from all
</FilesMatch>

# Protect PHP config files
<FilesMatch "^(db|security_config|performance)\.php$">
    Order allow,deny
    Deny from all
    # Allow PHP internal access
    Satisfy Any
    Allow from env=REDIRECT_STATUS
</FilesMatch>

# Protect backup files
<FilesMatch "\.(bak|backup|sql|log|ini|conf)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Protect git files
<FilesMatch "^\.git">
    Order allow,deny
    Deny from all
</FilesMatch>

# ============================================
# DIRECTORY SECURITY
# ============================================

# Disable directory listing
Options -Indexes

# Disable access to specific directories
<IfModule mod_rewrite.c>
    # Protect logs directory
    RewriteRule ^logs/ - [F,L]
    
    # Protect backups directory
    RewriteRule ^backups/ - [F,L]
    
    # Prevent PHP execution in uploads
    RewriteCond %{REQUEST_URI} ^/uploads/.*\.(php|php3|php4|php5|phtml|pl|py|jsp|asp|html|htm|shtml|sh|cgi)$ [NC]
    RewriteRule .* - [F,L]
</IfModule>

# ============================================
# PHP CONFIGURATION
# ============================================
<IfModule mod_php7.c>
    # Error reporting OFF in production
    php_flag display_errors Off
    php_flag display_startup_errors Off
    php_value error_reporting 0
    
    # Log errors instead
    php_flag log_errors On
    php_value error_log logs/php_errors.log
    
    # Upload settings (adjust based on your needs)
    php_value upload_max_filesize 5M
    php_value post_max_size 5M
    php_value max_execution_time 300
    php_value max_input_time 300
    php_value memory_limit 256M
    
    # Session security
    php_flag session.cookie_httponly On
    php_flag session.use_only_cookies On
    php_value session.cookie_samesite Strict
    
    # File upload security
    php_flag file_uploads On
    
    # Timezone
    php_value date.timezone "Asia/Jakarta"
</IfModule>

# For PHP 8.x
<IfModule mod_php8.c>
    php_flag display_errors Off
    php_flag display_startup_errors Off
    php_value error_reporting 0
    php_flag log_errors On
    php_value error_log logs/php_errors.log
    php_value upload_max_filesize 5M
    php_value post_max_size 5M
    php_value max_execution_time 300
    php_value memory_limit 256M
    php_flag session.cookie_httponly On
    php_flag session.use_only_cookies On
    php_value date.timezone "Asia/Jakarta"
</IfModule>

# ============================================
# COMPRESSION (GZIP)
# ============================================
<IfModule mod_deflate.c>
    # Compress HTML, CSS, JavaScript, Text, XML and fonts
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE application/x-font
    AddOutputFilterByType DEFLATE application/x-font-opentype
    AddOutputFilterByType DEFLATE application/x-font-otf
    AddOutputFilterByType DEFLATE application/x-font-truetype
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE font/opentype
    AddOutputFilterByType DEFLATE font/otf
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE image/x-icon
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
    
    # Remove browser bugs (optional)
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    Header append Vary User-Agent
</IfModule>

# ============================================
# BROWSER CACHING
# ============================================
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Images
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    
    # Others
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/x-javascript "access plus 1 month"
    ExpiresByType application/x-shockwave-flash "access plus 1 month"
    ExpiresByType text/html "access plus 0 seconds"
    
    # Default
    ExpiresDefault "access plus 1 week"
</IfModule>

# ============================================
# CUSTOM ERROR PAGES (Optional)
# ============================================
# Uncomment dan sesuaikan jika Anda punya custom error pages

# ErrorDocument 400 /error_pages/400.html
# ErrorDocument 401 /error_pages/401.html
# ErrorDocument 403 /error_pages/403.html
# ErrorDocument 404 /error_pages/404.html
# ErrorDocument 500 /error_pages/500.html

# ============================================
# DENY ACCESS TO SENSITIVE FILES
# ============================================
<FilesMatch "(check_deployment|test_security|phpinfo)\.php$">
    Order allow,deny
    Deny from all
</FilesMatch>

# ============================================
# DEFAULT CHARSET
# ============================================
AddDefaultCharset UTF-8
DefaultLanguage id-ID

# ============================================
# PREVENT HOTLINKING (Optional)
# ============================================
# Uncomment untuk prevent orang lain pakai gambar Anda

# <IfModule mod_rewrite.c>
#     RewriteCond %{HTTP_REFERER} !^$
#     RewriteCond %{HTTP_REFERER} !^https?://(www\.)?yourdomain\.com [NC]
#     RewriteRule \.(jpg|jpeg|png|gif|webp)$ - [F,L]
# </IfModule>